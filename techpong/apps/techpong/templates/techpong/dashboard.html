{% extends 'techpong/base.html' %}

{% block content %}
      <div class="wrapper">
            <!-- Left side column. contains the logo and sidebar -->

            <!-- Right side column. Contains the navbar and content of the page -->
            <aside class="right-side strech">
                <!-- Content Header (Page header) -->

                <!-- Main content -->
                <div id="alert_container"></div>

                <section class="content">
                    <div class="row">
                      <div class="col-lg-10">
                      </div>
                    </div>

                    <!-- Main row -->
                    <div class="row">
                        <!-- Left col -->
                        <section class="col-lg-8 col-md-12 connectedSortable">

                            <!-- Map box -->
                            <div class="box box-primary">
                                <div class="box-header">
                                <div class="pull-right box-tools">
                                  <button class="btn btn-success pull-right" data-toggle="modal" data-target="#addMatchModal" title="Add a Match" data-tooltip>
                                      <div class='fa fa-plus'></div>
                                  </button>
                                  <button class="btn btn-success pull-right" data-toggle="modal" data-target="#addPlayerModal" title="Add a New Player" data-tooltip>
                                      <div class='ion ion-person-add'></div>
                                  </button>
                                </div>
                                    <i class="fa fa-map-marker"></i>
                                    <h3 class="box-title">Ladder</h3>
                                </div>
                                <div class="box-body no-padding">
                                    <div class="table-responsive">

                                        <!-- .table - Uses sparkline charts-->
                                        <table class="table table-striped ladder">
                                            <tr>
                                                <th></th>
                                                <th>Player</th>
                                                <th>Recent Games</th>
                                                {% if company.show_rank %}
                                                <th>Rank History</th>
                                                {% endif %}
                                                {% if company.show_rating %}
                                                <th>Rating History</th>
                                                {% endif %}
                                            </tr>
                                            {% for player in info.players %}
                                            <tr class='player' data-player-id='{{player.id}}'>
                                              <td><div class='player_ranking'>{{player.rank or ''}}</div></td>
                                              <td><div class='player_name'><a href="{% url 'player' company_name=company.short_name,player_id=player.id %}">{{player.name}} {% if company.show_rating %}({{'%.02f'|format(player.rating)}}){% endif %}</a></div></td>
                                              <td><div class='player_sparkline_results' values="{{player.results_sparkline}}"></div></td>
                                              {% if company.show_rank %}
                                              <td><div class='player_sparkline_rank' values="{{player.rank_sparkline}}"></div></td>
                                              {% endif %}
                                              {% if company.show_rating %}
                                              <td><div class='player_sparkline_ratings' values="{{player.ratings_sparkline}}"></div></td>
                                              {% endif %}
                                            </tr>
                                            {% endfor %}
                                        </table><!-- /.table -->
                                    </div>
                                </div><!-- /.box-body-->
                                <div class="box-footer">
                                </div>
                            </div>
                            <!-- /.box -->

                        </section><!-- /.Left col -->

                        <!-- right col -->
                        <section class="col-lg-4 col-md-12 connectedSortable">
                            <!-- Chat box -->
                            <div class="box box-success">
                                <div class="box-header">
                                    <h3 class="box-title"><i class="fa fa-comments-o"></i> Recent Matches</h3>
                                   <!--
                                    <div class="box-tools pull-right">
                                        <ul class="pagination pagination-sm inline">
                                            <li><a href="#">&laquo;</a></li>
                                            <li><a href="#">1</a></li>
                                            <li><a href="#">2</a></li>
                                            <li><a href="#">3</a></li>
                                            <li><a href="#">&raquo;</a></li>
                                        </ul>
                                      </div>
                                      -->
                                </div>
                                <div class="box-body chat matches" id="chat-box">
                                  {% for match in info.recent_matches %}
                                    {% include 'techpong/partials/match_row.html' %}
                                  {% endfor %}
                                </div><!-- /.chat -->
                            </div><!-- /.box (chat box) -->

                        </section><!-- right col -->
                    </div><!-- /.row (main row) -->

                </section><!-- /.content -->
            </aside><!-- /.right-side -->
          </div><!-- ./wrapper -->


<div class="modal fade" id="addMatchModal" tabindex="-1" role="dialog" aria-labelledby="addMatchModalLabel" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="addMatchModalLabel">Add New Match</h4>
      </div>
      <div class="modal-body">

        <form role="form">
          <div class="form-group">
            <div class="row">
              <div class="col-xs-2">
                <label for="addMatchWinner">Winner:</label>
              </div>
              <div class="col-xs-10">
                <select id='addMatchWinner' class='player_select'>
                  <option value=''>-----</option>
                </select>
              </div>
              <div class="col-xs-2">
                <label for="addMatchLoser">Loser:</label>
              </div>
              <div class="col-xs-10">
                <select id='addMatchLoser' class='player_select'>
                  <option value=''>-----</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col-xs-4">
                <label class="game-label">Game 1:</label>
              </div>
              <div class="col-xs-4">
                <label class="game-label">Game 2:</label>
              </div>
              <div class="col-xs-4">
                <label class="game-label">Game 3:</label>
              </div>
            </div>
            <div class="row score_row">
              <div class="col-xs-2">
                <label for="game1Winner">Winner:</label>
                <select id="game1Winner" class="score-select input-small"></select>
              </div>
              <div class="col-xs-2">
                <label for="game1Loser">Loser:</label>
                <select id="game1Loser" class="score-select input-small"></select>
              </div>

              <div class="col-xs-2">
                <label for="game2Winner">Winner:</label>
                <select id="game2Winner" class="score-select input-small"></select>
              </div>
              <div class="col-xs-2">
                <label for="game2Loser">Loser:</label>
                <select id="game2Loser" class="score-select input-small"></select>
              </div>

              <div class="col-xs-2">
                <label for="game3Winner">Winner:</label>
                <select id="game3Winner" class="score-select input-small"></select>
              </div>
              <div class="col-xs-2">
                <label for="game3Loser">Loser:</label>
                <select id="game3Loser" class="score-select input-small"></select>
              </div>

            </div>
          </div>
        </form>
        <div id="addMatchAlertContainer"></div>
      </div>
       <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="addMatchModalSave">Add Match</button>
      </div>
    </div>
</div>

<div class="modal fade" id="addPlayerModal" tabindex="-1" role="dialog" aria-labelledby="addPlayerModalLabel" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="addMatchModalLabel">Add New Player</h4>
      </div>
      <div class="modal-body">
        <form role="form">
          <div class="form-group">
            <div class="row">
              <div class="col-md-6">
                <label for="addPlayerName">Name:</label>
                <input id="addPlayerName"/>
              </div>
            </div>
          </div>
        </form>
      </div>
       <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="addPlayerSave">Add Player</button>
      </div>
    </div>
</div>
        {% endblock content %}

{% block additional_js %}
<script type='text/javascript'>

  $(document).on('ready', function(){
      $('.player_sparkline_results').sparkline('html', {type: 'tristate'});
      $('.player_sparkline_ratings').sparkline();
      $('.player_sparkline_rank').sparkline('html', {
//        tooltipFormatter: function() {

 //       }
      });

      $('#addMatchModalSave').on('click', function(){
        var winner = $('#addMatchWinner').val();
        var loser = $('#addMatchLoser').val();

        var game1winner = $('#game1Winner').val();
        var game1loser = $('#game1Loser').val();

        var game2winner = $('#game2Winner').val();
        var game2loser = $('#game2Loser').val();

        var game3winner = $('#game3Winner').val();
        var game3loser = $('#game3Loser').val();

        // target for in-modal alerts
        var alert_target = $("#addMatchAlertContainer");

        // validate selected players
        if (winner <= 0 || loser <= 0 || !winner || !loser || winner == loser) {
          showError("Stop trying to break the system", alert_target);
          $("#addMatchModal").modal("hide");
          return;
        }

        // validate scores
        if (!(game1winner == 0 && game1loser == 0
            && game2winner == 0 && game2loser == 0
            && game3winner == 0 && game3loser == 0)) {

          if (
              (game1winner == 11 && game1loser == 11)
              || (game2winner == 11 && game2loser == 11)
              || (game3winner == 11 && game3loser == 11) ) {
              showError("Game Scores Appear Invalid", alert_target);
              return;
          }

          if ((game1winner != 11 && game1loser != 11)
              || (game2winner != 11 && game2loser != 11)) {
              showError("Game Scores Appear Invalid - Not Enough Games Won", alert_target);
              return;
          }

          // validate winner won exactly two games
          var g1 = game1winner == 11;
          var g2 = game2winner == 11;
          var g3 = game3winner == 11;

          if ( ! ((g1&&g2&&!g3) || (g1&&!g2&&g3) || (!g1&&g2&&g3)) ) {
              showError("Game Scores Appear Invalid - Invalid Winner", alert_target);
              return;
          }

          // verify no third game was played if winner won first 2 games
          if (g1 && g2 && (game3winner != 0 || game3loser != 0)) {
            showError("Game Scores Appear Invalid - Invalid Third Game", alert_target);
            return;
          }
        }

        // send to server
        $("#addMatchModalSave").attr("disabled", true);
        $.ajax("{% url 'ajax_add_match' company_name=company.short_name %}", {
          method: "POST",
          headers: {"X-CSRFToken": "{{ csrf_token|safe() }}"},
          data: {
            winner: winner,
            loser: loser,
            game1winner: game1winner, game1loser: game1loser,
            game2winner: game2winner, game2loser: game2loser,
            game3winner: game3winner, game3loser: game3loser
          },
          success: function(response) {
            if (response.success) {
              // todo: update without reload
              window.location.reload();
              //$("#addMatchModal").find(".player_select").val(0);
              //$("#addMatchModal").modal("hide");
            }
            else {
              $("#addMatchModalSave").attr("disabled", false);
              var error_message = "There was an error while creating the match. Go yell at whomever set this up.";
              if (response.error_message) {
                error_message = response.error_message;
              }
              showError(error_message);
              $("#addMatchModal").modal("hide");
            }
          },
          failure: function(response) {
            $("#addMatchModalSave").attr("disabled", false);
            showError("Error creating match. Go yell at whomever set this up.");
            $("#addMatchModal").modal("hide");
          },
          error: function(response) {
            $("#addMatchModalSave").attr("disabled", false);
            showError("Error creating match. Go yell at whomever set this up.");
            $("#addMatchModal").modal("hide");
          }
        });
      });

      $('#addPlayerSave').on('click', function(){
        var name = $('#addPlayerName').val();

        // validate player name
        if (!name) {
          showError("Stop trying to break the system");
          $("#addPlayerModal").modal("hide");
          return;
        }

        // send to server
        $("#addPlayerName").attr("disabled", true);
        $.ajax("{% url 'ajax_add_player' company_name=company.short_name %}", {
          method: "POST",
          headers: {"X-CSRFToken": "{{ csrf_token|safe() }}"},
          data: {
            name: name
          },
          success: function(response) {
            if (response.success) {
              // todo: update without reload
              window.location.reload();
              //$("#addPlayerModal").find(".player_select").val(0);
              //$("#addPlayerModal").modal("hide");
            }
            else {
              $("#addPlayerName").attr("disabled", false);
              var error_message = "There was an error while adding the new player. Go yell at whomever set this up.";
              if (response.error_message) {
                error_message = response.error_message;
              }
              showError(error_message);
              $("#addPlayerModal").modal("hide");
            }
          },
          failure: function(response) {
            showError("Error creating new player. Go yell at whomever set this up.");
            $("#addPlayerModal").modal("hide");
          },
          error: function(response) {
            showError("Error creating new player. Go yell at whomever set this up.");
            $("#addPlayerModal").modal("hide");
          }

        });

      });

      // populate player selectors
      var players = {{info.players_json|safe()}};
      var option;
      for (var i = 0; i < players.length; i++) {
        var option = $("<option/>").val(players[i].id).text(players[i].name);
        $(".player_select").append(option);
      }

      // populate score selectors
      for (var i=0; i <= 11; i++) {
        var option = $("<option/>").val(i).text(i);
        $(".score-select").append(option);
      }
  });

  function showError(message, target) {
    showAlert(message, 'alert-danger', target);
  }

  function showSuccess(message) {
    showAlert(message, 'alert-success');
  }

  function showAlert(message, alert_class, target) {
    var alert_div = $('<div/>').addClass('alert '+alert_class).text(message);
    alert_div.append(
      $('<button/>')
        .addClass('close fade in')
        .attr({
          'data-dismiss': 'alert',
          'aria-hidden': 'true'
        })
        .html("&times;")
    );
    alert_div.appendTo(target || $('#alert_container'));
    alert_div.alert();

    setTimeout(function(){ alert_div.alert('close'); }, 3500);
  }

</script>
{% endblock additional_js %}
